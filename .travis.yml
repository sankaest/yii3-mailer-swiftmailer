language: php

env:
  global:
    - DEFAULT_COMPOSER_FLAGS="--prefer-dist --no-interaction --no-progress --optimize-autoloader"
    - TASK_STATIC_ANALYSIS=0
    - TASK_TESTS_COVERAGE=0

matrix:
  include:
    - php: "7.4"
      env:
        - TASK_STATIC_ANALYSIS=0 # set to 1 to enable static analysis
        - TASK_TESTS_COVERAGE=1

# faster builds on new travis setup not using sudo
sudo: false

# cache vendor dirs
cache:
  directories:
    - $HOME/.composer/cache

before_install:
  - phpenv config-rm xdebug.ini || echo "xdebug is not installed"

install:
  - travis_retry composer self-update && composer --version
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - travis_retry composer install $DEFAULT_COMPOSER_FLAGS
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      pecl install ast
    fi

before_script:
  - php --version
  - composer --version
  # enable code coverage
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
        PHPUNIT_COVERAGE_FLAG="--coverage-clover=coverage.clover"
    fi

script:
  - phpdbg -qrr vendor/bin/phpunit --verbose $PHPUNIT_COVERAGE_FLAG
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      composer phan
    fi
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      cat analysis.txt
    fi

after_script:
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
      travis_retry wget https://scrutinizer-ci.com/ocular.phar
      php ocular.phar code-coverage:upload --format=php-clover coverage.clover
    fi

notifications:
  slack:
    -
      rooms:
        -
          secure: hNVQNYYf6U9c62jRwhxRyEacjMivp2x0/dd0jsXAykwrtblZkOpkE/JrTzfAthk9Wa0YpPmBT68t6B4Su3CTgHl3yF0+7Uwbk7aiiDC+rxLZDHGv0vAK1NUp/IEXXlownhhxu11L1dexsojMo3+cMdtht1rPyRcZAFyCzYvgljziPmU8fZiZAUbepn0Zy0ts0hYvINt4yUtoKeQj+qlusurSEIWARURTASP8iq5+R4t74pw1wicPxpKB9+MwP7kofs8xeQPjVyrES4A0z0cb/EFB+LI3q1XB3kp8+e9eDSL9ixlvu1xMZCHTZXSVoGFmvRQuTD2iQqiss3mEGo3FsgmlOLdyBuC1fFyxyMlomkyNwHpTLdh47GaxqozWdcp2UHAkQvxsqtIrEC8cWk4bwTrA555pVefo9Vl/BpWHlPVgO3+cxLCtcxrm8Q+dEq2q5SBL/H52Mv/iPkk69zxhR2Bxq9V04Ik82yK7T5yF/yOTCGT1tcyaGu/fXxitHASqcH5YZtq9EdkqqwKVa+yCNcf00T2rnrY3oYOM3HY0S5zt+4TjZMq/yo4Bdra02a6DdIe6e7k8Ip1HwQcD4/GclLf1n2Fl4HSi5Bb4G6Xw2s3pj5DxJ6h7dfE3z1p8L2Ac0Q1UqbWevoZqcuxJ8DlDq8yb+gFTeWEziOt8GcKAmQw=
      on_success: always
      on_failure: never
      on_pull_requests: false
    -
      rooms:
        -
          secure: kSyU2oqeNXjTNZ1vfkXHIFK4ox8kVFzPPgvd2aAp5N+U5pf35anacwgwrIgWDKUEE+AZZv0ZutcMecWX5rFsxiK5H8tJlvTKUguEwBxOUSlXtVcd3zVeeDhi1GN6RyQ1kVP59+ff97vVK4wpRlZ5YNCPAzWQ+3hHPXkcFW3SFG5+ZDW7ZjdCYWGbmyJaj4X6iH+L4PFIpDP9Kas6aW0qXJh0JH93vLDOl4nkXPbGLhsiieOvvuwtJU2cdoYkTJEsHQgq0kQ+vtBS+xaOsd1H0HrCXk2jeq/uBoRwXMbtKYvLuiKaiSwRGYrqpQhd+aJxitZMDJnk4V8qnNfCUS79KFoE1pMRKtSEKsEmivnadLlFGiHAMPTOBCErmv/fmeGMFR9cBl+X1GDBEZhsVY3Gz/LwekdqcVkpyx9V7QzwDI26a87BJfxbGVAB/Z8YDTTgv0ul+xFSsSykftFNoZpaDMj1YYVQEjgVG0Dls4fYMRarTxlYcrtYKdFp/dFbI+e+2uR/0kJJR8L6J2OBBEoPbq6mRS+6JuJk6pBJWJCZV6yQBuJ893+MEyAMyrWKvA4e2q2GKQYXcVPPV1BWZ/HSS9fmOhBFK1JSQu1rTuhu05RXH12s2zYD0fufbxaSWM/5O6igxuUy/G1kuKSxsTOpfZyUSzwQ3qnN/s8iVIHg9e0=
      on_success: never
      on_failure: always
      on_pull_requests: false
